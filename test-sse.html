<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE æ ¼å¼æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #output { background: #f5f5f5; padding: 10px; border: 1px solid #ddd; white-space: pre-wrap; }
        button { padding: 10px 20px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>SSE æ ¼å¼æµ‹è¯•</h1>
    <button onclick="testSSE()">æµ‹è¯• SSE è¿æ¥</button>
    <button onclick="clearOutput()">æ¸…ç©ºè¾“å‡º</button>
    <div id="output">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>

    <script>
        let eventSource = null;

        function testSSE() {
            if (eventSource) {
                eventSource.close();
            }

            const output = document.getElementById('output');
            output.textContent = 'æ­£åœ¨è¿æ¥...\n';

            eventSource = new EventSource('http://localhost:8000/api/chat/stream/lmpI42ID_JQ9V5MLppjk1?speed=fast&baseDelay=50');

            eventSource.onopen = function() {
                output.textContent += 'âœ… SSE è¿æ¥å·²å»ºç«‹\n\n';
            };

            eventSource.onmessage = function(event) {
                output.textContent += `ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${event.data}\n`;
                output.scrollTop = output.scrollHeight;
            };

            eventSource.addEventListener('message_chunk', function(event) {
                output.textContent += `ğŸ”¹ message_chunk: ${event.data}\n`;
                output.scrollTop = output.scrollHeight;
            });

            eventSource.addEventListener('tool_calls', function(event) {
                output.textContent += `ğŸ”§ tool_calls: ${event.data}\n`;
                output.scrollTop = output.scrollHeight;
            });

            eventSource.onerror = function(error) {
                console.error('SSE Error:', error);
                output.textContent += '\nâŒ è¿æ¥å‡ºé”™\n';
                eventSource.close();
            };
        }

        function clearOutput() {
            document.getElementById('output').textContent = 'ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...';
        }

        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
</html>
